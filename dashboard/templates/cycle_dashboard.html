{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 id="cycle-id-title"><a href="/" class="text-decoration-none text-dark">ğŸ </a> ì‚¬ì´í´: {{ cycle_id }}</h3>
    <span id="main-status-badge" class="badge bg-secondary text-dark fs-6">ë¡œë”©ì¤‘...</span>
</div>

<div class="row">
    <!-- 14-Step Workflow -->
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                14-Step Workflow
            </div>
            <ul class="list-group list-group-flush" id="workflow-steps">
                <li id="step-1" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-loader-4-line"></i> 1. ìë£Œ ì¡°ì‚¬ (AI)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-2" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-user-search-line"></i> 2. ì£¼ì œ/í¬ë§· ì„ íƒ (PM)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-3" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-loader-4-line"></i> 3. êµ¬ì¡° ì„¤ê³„ (AI)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-4" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-user-search-line"></i> 4. êµ¬ì¡° ì»¨íŒ (PM)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-5" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-loader-4-line"></i> 5. í’€ ì½˜í…ì¸  ì‘ì„± (AI)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-6" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-loader-4-line"></i> 6. ê¸°ì´ˆ ê²€ìˆ˜ (AI)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-7" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-loader-4-line"></i> 7. ë¦¬ì¹˜ ì½˜í…ì¸  ë Œë”ë§</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-8" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-user-search-line"></i> 8. ì›ë³¸ ìµœì¢… ê²€ìˆ˜ (PM)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-9" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-loader-4-line"></i> 9. SNS ë³€í˜• (AI)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-10" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-loader-4-line"></i> 10. SNS ê¸°ì´ˆ ê²€ìˆ˜ (AI)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-11" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-user-search-line"></i> 11. SNS ìµœì¢… ê²€ìˆ˜ (PM)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-12" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-loader-4-line"></i> 12. ì „ì²´ ë²ˆì—­ (AI)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-13" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-loader-4-line"></i> 13. ë²ˆì—­ ê²€ìˆ˜/êµì • (AI)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
                <li id="step-14" class="list-group-item d-flex justify-content-between align-items-center text-muted"><span><i class="ri-send-plane-line"></i> 14. ìµœì¢… ë°°í¬ (PM)</span> <span class="badge bg-light text-dark">ëŒ€ê¸°</span></li>
            </ul>
        </div>
    </div>

    <!-- Log Viewer -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                ë¡œê·¸ ë·°ì–´
            </div>
            <div id="log-viewer" class="card-body bg-dark text-light font-monospace" style="height: 600px; overflow-y: scroll;">
                <pre>ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</pre>
            </div>
        </div>
    </div>
</div>


<!-- Modal 2: ì‚°ì¶œë¬¼ ë·°ì–´ & ê²€ìˆ˜ -->
<div class="modal modal-xl fade" id="modal-reviewer" tabindex="-1" aria-labelledby="reviewerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewerModalLabel">ì‚°ì¶œë¬¼ ê²€ìˆ˜</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="reviewerTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="markdown-tab" data-bs-toggle="tab" data-bs-target="#markdown-pane" type="button" role="tab">Markdown (ìˆ˜ì •)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview-pane" type="button" role="tab">HTML í”„ë¦¬ë·°</button>
                    </li>
                </ul>
                <div class="tab-content" id="reviewerTabContent">
                    <div class="tab-pane fade show active" id="markdown-pane" role="tabpanel">
                        <!-- EasyMDE ì—ë””í„°ê°€ ì—¬ê¸°ì— ë¡œë“œë  ê²ƒì…ë‹ˆë‹¤. -->
                        <textarea id="easymde-editor"></textarea>
                    </div>
                    <div class="tab-pane fade" id="preview-pane" role="tabpanel">
                        <iframe srcdoc="<p>HTML í”„ë¦¬ë·°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>" style="width: 100%; height: 500px; border: 1px solid #ccc;"></iframe>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modal-assets"><i class="ri-image-add-line"></i> ì—ì…‹ ì‚½ì…</button>
                <button type="button" class="btn btn-light"><i class="ri-code-box-line"></i> ì»´í¬ë„ŒíŠ¸ ì‚½ì…</button>
                <div class="ms-auto">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-primary">ì €ì¥</button>
                    <button type="button" class="btn btn-success">ìŠ¹ì¸</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal 4: ì—ì…‹ ì‚½ì… -->
<div class="modal fade" id="modal-assets" tabindex="-1" aria-labelledby="assetsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assetsModalLabel">ì—ì…‹ ì‚½ì…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>assets/emoji/ í´ë”ì˜ ì´ë¯¸ì§€ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                <!-- ì´ë¯¸ì§€ ëª©ë¡ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-target="#modal-reviewer" data-bs-toggle="modal">ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/easymde.min.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cycleId = '{{ cycle_id }}';
    const mainStatusBadge = document.getElementById('main-status-badge');
    const logViewer = document.getElementById('log-viewer');
    const workflowSteps = document.getElementById('workflow-steps');

    // EasyMDE ì´ˆê¸°í™” ë¡œì§
    const reviewerModal = document.getElementById('modal-reviewer');
    let easyMDE;
    reviewerModal.addEventListener('shown.bs.modal', function () {
        if (!easyMDE) {
            easyMDE = new EasyMDE({
                element: document.getElementById('easymde-editor'),
                spellChecker: false,
                placeholder: "ì½˜í…ì¸ ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”...",
                initialValue: "### Step 4: êµ¬ì¡° ì»¨íŒ\n\n- í•­ëª© 1\n- í•­ëª© 2\n- í•­ëª© 3"
            });
        }
    });

    // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateStatusUI(manifest) {
        const status = manifest.status;
        const currentStep = status.step;

        // ë©”ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        mainStatusBadge.textContent = status.text;
        const statusClass = getStatusClass(status.code);
        mainStatusBadge.className = `badge ${statusClass} fs-6`;

        // ë¡œê·¸ ë·°ì–´ ì—…ë°ì´íŠ¸ (ê°„ë‹¨í•œ ì˜ˆì‹œ)
        if (manifest.logs) {
            // logViewer.querySelector('pre').textContent = manifest.logs;
        }

        // 14ë‹¨ê³„ ì›Œí¬í”Œë¡œìš° UI ì—…ë°ì´íŠ¸
        for (let i = 1; i <= 14; i++) {
            const stepElement = document.getElementById(`step-${i}`);
            if (!stepElement) continue;

            const icon = stepElement.querySelector('i');
            const textSpan = stepElement.querySelector('span:first-child');
            const badge = stepElement.querySelector('.badge');
            
            // ê¸°ì¡´ ì•¡ì…˜ ë²„íŠ¼ ì œê±°
            const existingActions = stepElement.querySelector('.step-actions');
            if (existingActions) {
                existingActions.remove();
            }

            let actionsDiv = document.createElement('div');
            actionsDiv.className = 'step-actions';

            let stepStatus = "FUTURE"; // ê¸°ë³¸ ìƒíƒœ

            if (i < currentStep) {
                stepStatus = "COMPLETED";
            } else if (i === currentStep) {
                stepStatus = status.code;
            }

            // ìƒíƒœì— ë”°ë¼ UI ì—…ë°ì´íŠ¸
            if (stepStatus === "COMPLETED") {
                stepElement.className = 'list-group-item d-flex justify-content-between align-items-center';
                icon.className = 'ri-check-line text-success';
                badge.className = 'badge bg-success';
                badge.textContent = 'ì™„ë£Œ';
            } else if (stepStatus.includes('PENDING_APPROVAL')) {
                stepElement.className = 'list-group-item d-flex justify-content-between align-items-center';
                icon.className = 'ri-user-search-line text-warning';
                badge.className = `badge ${getStatusClass(stepStatus)}`;
                badge.textContent = 'ìŠ¹ì¸ ëŒ€ê¸°';
                actionsDiv.innerHTML = `<button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modal-reviewer" data-step-id="${i}">ê²€í† í•˜ê¸°</button>`;
            } else if (stepStatus.includes('RUNNING')) {
                stepElement.className = 'list-group-item d-flex justify-content-between align-items-center';
                icon.className = 'ri-loader-4-line text-primary animation-spin';
                badge.className = `badge ${getStatusClass(stepStatus)}`;
                badge.textContent = 'ì§„í–‰ì¤‘';
                actionsDiv.innerHTML = `<button class="btn btn-primary btn-sm" disabled><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></button>`;
            } else if (stepStatus.includes('PENDING')) {
                 stepElement.className = 'list-group-item d-flex justify-content-between align-items-center';
                icon.className = 'ri-play-circle-line text-primary';
                badge.className = `badge ${getStatusClass(stepStatus)}`;
                badge.textContent = 'ì‹¤í–‰ ëŒ€ê¸°';
                actionsDiv.innerHTML = `<button class="btn btn-primary btn-sm run-step" data-step-id="${i}">ì‹¤í–‰</button>`;
            } else { // FUTURE or ERROR
                const isError = stepStatus.includes('ERROR') || stepStatus.includes('FAIL');
                stepElement.className = isError ? 'list-group-item d-flex justify-content-between align-items-center' : 'list-group-item d-flex justify-content-between align-items-center text-muted';
                icon.className = isError ? 'ri-error-warning-line text-danger' : (stepElement.querySelector('i').className); // ê¸°ë³¸ ì•„ì´ì½˜ ìœ ì§€
                badge.className = `badge ${getStatusClass(stepStatus)}`;
                badge.textContent = isError ? 'ì˜¤ë¥˜' : 'ëŒ€ê¸°';
                 if (isError) {
                    actionsDiv.innerHTML = `<button class="btn btn-danger btn-sm run-step" data-step-id="${i}">ì¬ì‹œë„</button>`;
                }
            }
            stepElement.appendChild(actionsDiv);
        }
    }

    function getStatusClass(code) {
        if (code.includes('ERROR') || code.includes('FAIL')) return 'bg-danger';
        if (code.includes('PENDING_APPROVAL')) return 'bg-warning text-dark';
        if (code.includes('RUNNING')) return 'bg-info text-dark';
        if (code.includes('COMPLETE') || stepStatus === "COMPLETED") return 'bg-success';
        if (code.includes('PENDING')) return 'bg-primary';
        return 'bg-light text-dark';
    }

    // ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•œ í´ë¦­ í•¸ë“¤ëŸ¬
    workflowSteps.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('run-step')) {
            const button = e.target;
            const stepId = button.dataset.stepId;

            button.disabled = true;
            button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;

            fetch(`/api/cycle/${cycleId}/run/${stepId}`, {
                method: 'POST',
            })
            .then(response => {
                if (response.status === 409) { // Conflict
                     alert('ì´ë¯¸ ì‹¤í–‰ì¤‘ì´ê±°ë‚˜ ëŒ€ê¸°ì¤‘ì¸ ì‘ì—…ì…ë‹ˆë‹¤.');
                }
                // ì¦‰ì‹œ ìƒíƒœë¥¼ ë‹¤ì‹œ í´ë§í•˜ì—¬ UI ì—…ë°ì´íŠ¸
                pollStatus();
            })
            .catch(error => {
                console.error('Error running step:', error);
                alert(`Step ${stepId} ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ`);
                button.disabled = false;
                button.textContent = 'ì¬ì‹œë„';
            });
        }
    });

    // ìƒíƒœ í´ë§ í•¨ìˆ˜
    function pollStatus() {
        fetch(`/api/cycle/${cycleId}/status`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    updateStatusUI(data);
                }
            })
            .catch(error => {
                console.error('Error fetching status:', error);
                mainStatusBadge.textContent = 'ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨';
                mainStatusBadge.className = 'badge bg-danger fs-6';
            });
    }

    // 5ì´ˆë§ˆë‹¤ í´ë§ ì‹œì‘ ë° ì¦‰ì‹œ 1íšŒ ì‹¤í–‰
    setInterval(pollStatus, 5000);
    pollStatus();
});
</script>
{% endblock %}
